{{ define "main" }}
<section class="page-header">
  <h1>{{ .Title }}</h1>
  {{ with .Content }}<div class="page-description">{{ . }}</div>{{ end }}
</section>

{{ $withSeries := where .Pages "Params.series" "!=" "" }}

{{/* Series sections — sorted by series_weight */}}
{{ $groups := $withSeries.GroupByParam "series" }}
{{ $ordered := slice }}
{{ range $groups }}
  {{ $sw := 999 }}
  {{ range .Pages }}
    {{ with .Params.series_weight }}{{ if lt (int .) $sw }}{{ $sw = int . }}{{ end }}{{ end }}
  {{ end }}
  {{ $ordered = $ordered | append (dict "Key" .Key "Pages" .Pages "Order" $sw) }}
{{ end }}
{{ range sort $ordered "Order" }}
<section class="series-section">
  <h2 class="series-heading">{{ .Key }}</h2>
  <ol class="post-list series-posts">
    {{ range sort .Pages "Weight" }}
    <li>
      <a href="{{ .RelPermalink }}">{{ .Title }}</a>
      {{ with .Description }}<span class="post-desc"> — {{ . }}</span>{{ end }}
    </li>
    {{ end }}
  </ol>
</section>
{{ end }}

{{/* Then standalone posts (those without a series) */}}
{{ $hasSingles := false }}
{{ range .Pages }}{{ if not .Params.series }}{{ $hasSingles = true }}{{ end }}{{ end }}
{{ if $hasSingles }}
<section class="series-section">
  <h2 class="series-heading">Other</h2>
  <ul class="post-list">
    {{ range .Pages }}
    {{ if not .Params.series }}
    <li>
      <a href="{{ .RelPermalink }}">{{ .Title }}</a>
      {{ with .Description }}<span class="post-desc"> — {{ . }}</span>{{ end }}
    </li>
    {{ end }}
    {{ end }}
  </ul>
</section>
{{ end }}
{{ end }}